@page "/new-user"
@layout MainLayout
@inject AuthService AuthService
@inject NavigationManager NavigationManager
@attribute [Authorize(Roles = "Admin")]

<PageTitle>New User</PageTitle>

<MudItem sm="5">
    <MudCard>
        <MudCardContent Class="justify-md-center ">
            <MudForm @ref="form" @bind-IsValid="@isValid">
                <MudTextField @bind-Value="newUser.FirstName" T="string" Label="FirstName" Required="true"/>
                <MudTextField @bind-Value="newUser.LastName" T="string" Label="LastName" Required="true"/>
                <MudTextField @bind-Value="newUser.Idnp" T="string" Label="IDNP" Required="true"/>
                <MudTextField @bind-Value="newUser.Password" T="string" Label="Password" InputType="InputType.Password" Required="true"/>
                <MudSelect T="string" @bind-SelectedValues="options" MultiSelection="true" Label="Roles" Required="true">
                    <Virtualize Items="roles" Context="role">
                        <MudSelectItem Value="@role">@role</MudSelectItem>
                    </Virtualize>
                </MudSelect>
            </MudForm>
        </MudCardContent>
        <MudButton Variant="Variant.Filled" OnClick="@CreateNewUser" Color="Color.Secondary" DisableElevation="true" Disabled="@(!isValid)" Class="ma-4">Create User</MudButton>
    </MudCard>
</MudItem>

@code {
    readonly string[] roles = Enum.GetValues<UserRole>().Select(x => x.ToString()).ToArray();
    private static IEnumerable<string> options { get; set; } = new HashSet<string> { "User" };
    readonly RegisterDto newUser = new();
    MudForm form;
    bool isValid;

    protected override async Task OnInitializedAsync()
    {
        var isAuthenticated = await AuthService.IsUserAuthenticated();

        if (!isAuthenticated)
            NavigationManager.NavigateTo("/login");
    }

    public async Task CreateNewUser()
    {
        await form.Validate();
        newUser.Roles = options.Select(x => x).ToArray();
        var result = await AuthService.Register(newUser);

        if (result.Status)
        {
            Snackbar.Add("User Successfully Created", Severity.Success);
            await form.ResetAsync();
        }
        else
        {
            Snackbar.Add($"{result.Message}", Severity.Error);
            return;
        }

        StateHasChanged();
    }

}
